{ config
, lib
, ...
}:
let
  cfg = config.networking.fw-proxy;
  inherit (config.networking) hostName;
in
{
  networking.fw-proxy = {
    enable = true;
    tproxy = {
      enable = true;
      cgroup = "tproxy.slice";
    };
    mixinConfig = {
      port = config.ports.proxy-http;
      socks-port = config.ports.proxy-socks;
      mixed-port = config.ports.proxy-mixed;
      tproxy-port = config.ports.proxy-tproxy;
      log-level = "info";
      external-controller = "127.0.0.1:${toString config.ports.clash-controller}";
    };
    externalController = {
      expose = false;
      virtualHost = "${hostName}.*";
      location = "/clash/";
      secretFile = config.sops.secrets."ssh/id_ed25519".path;
    };
  };

  # sops.secrets."fw_proxy_external_controller_secret" = {
  #   sopsFile = config.sops-file.get "terraform/common.yaml";
  #   restartUnits = [ "clash-auto-update.service" ];
  # };

  networking.fw-proxy.auto-update = {
    enable = false;
    service = "main";
  };

  systemd.services.nix-daemon.environment = cfg.environment;
}
